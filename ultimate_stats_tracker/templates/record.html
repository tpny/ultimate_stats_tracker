{% extends "base.html" %}
{% block list_games_active %}active{% endblock %}
{% block list_manage_game %}Return to Manage Games{% endblock %}
{% block content %}
<h2 class="text-center">Recording for team {{team_name}}</h2>
<hr>
<div class="d-flex flex-row justify-content-between">
  <div class="vr"></div>
  <div class="w-25 p-3">
    <div class="table-responsive">
      <table class="table text-center ">
        <thead>
          <tr>
            <th scope="col">Recent Plays</th>
          </tr>
        </thead>
        <tbody id="recent_plays_table">
        </tbody>
      </table>
    </div>
  </div>
  <div class="vr"></div>
  <div class="d-flex align-content-start flex-wrap w-50 m-3">
    {% for player_id, player_name in players_in_team %}
    <form class="play_form my-1 mx-1 flex-fill text-truncate">
      <input type="hidden" name="player_id" value="{{player_id}}">
      <input type="submit" name="button" value="{{player_name}}" id="{{player_id}}" class ="btn btn-primary btn-lg btn-lg form-control"  {% if player_name in invalid_moves %} disabled {% endif %}>
    </form>
    {% endfor %}
  </div>
  <div class="vr"></div>
  <div class="d-flex flex-column text-center p-3">
    <div class="d-flex flex-column justify-content-between">
      {% for action in actions %}
      <form class="play_form my-1">
        <input type="submit" name="button" value="{{action}}" id="{{action}}" class ="form-control btn btn-secondary btn-lg btn-block" {% if action in invalid_moves %} disabled {% endif %}>
      </form>
      {% endfor %}
      <br>
      <br>
      <form class="play_form my-1">
        <input type="submit" name="button" value="UNDO" id="UNDO" class ="form-control btn btn-outline-warning btn-lg btn-block" {% if disable_undo %} disabled {% endif %}>
      </form>
    </div>
  </div>
  <div class="vr"></div>
</div>
<br>
<hr>
<br>
<div class="table-responsive">
  <table id="stats_table" class="table" {{hide_stats}}>
    <thead>
      <tr>
        <th scope="col" class="text-center">Player</th>
        {% for header_item in stats_header %}
        <th scope="col" class="text-center">{{header_item}}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody id="player_stats_table">
    {% for player, stats in player_stats.items() %}
    <tr>
      <th scope="row" class="text-center">{{player}}</th>
      {% for value in stats %}
      <td class="text-center">{{value}}</td>
      {% endfor %}
    </tr>
    {% endfor %}
    <tr {% if has_deleted == False %} hidden {% endif %}>
      <th scope="row" class="text-center">DELETED_PLAYER</th>
      {% for value in deleted_player_stats %}
      <td class="text-center">{{value}}</td>
      {% endfor %}
    </tr>
    </tbody>
  </table>
</div>
{% endblock %}
{% block script %}
<script type="text/javascript">
  var game_id = "{{game_id}}";
  var team_id = "{{team_id}}";
  var id_to_players = JSON.parse('{{id_to_players|tojson}}');
  var play_seq = "{{play_str}}".split(",");
  var stats_length = {{stats_header|length}};
  // var play_seq = [];

  function update_recent_play() {
    $("#recent_plays_table tr").remove();
    $.each(play_seq.slice(-10).reverse(), function( key, value ) {
      if(id_to_players.hasOwnProperty(value)){
        value = id_to_players[value];
      }

      let fade_class = "";
      if(key < 3 ){
        fade_class = "text-body-emphasis";
      }else if(key < 7 ){
        fade_class = "text-body-secondary";
      }else{
        fade_class = "text-body-tertiary";
      }
      $("#recent_plays_table").append('<tr><td scope="row" class="' + fade_class + '">' + value + '</td></tr>');
    }); 
  }

  $(document).ready(function () {
    update_recent_play()
    $(".play_form").submit(function (event) {
      event.preventDefault();
      if(event.target.elements.namedItem('player_id')){
        play_seq.push(event.target.elements.namedItem('player_id').value);
      }else{
        let action = event.target.elements.namedItem('button').value;
        if(action == "UNDO"){
          play_seq.pop();
        }else{
          play_seq.push(action);
        }
      }

      let formData = {
        play_str: play_seq.join(","),
        game_id: game_id,
        team_id: team_id,
      };

      $.ajax({
        type: "POST",
        url: "/api/record",
        data: formData,
        dataType: "json",
        encode: true,
      }).done(function (data) {
        $( ".btn").each(function() {
          $(this).prop( "disabled", false );
        });

        $.each(data.invalid_moves, function( index, value ) {
          $( "#" + value ).prop( "disabled", true );
        });

        if(data.player_stats.length){
          $('#stas_table').prop( "hidden", false );
        }else{
          $('#stas_table').prop( "hidden", true );
        }

        $("#player_stats_table tr").remove()
        let deleted_player_stats = Array(stats_length).fill(0);
        for(let player_id in data.player_stats){
          let player_name = id_to_players[player_id];
          if(player_name == "DELETED PLAYER") {
            for(let index = 0; index < stats_length; index++){
              deleted_player_stats[index] += data.player_stats[player_id][index];
            }
          }; 
          $("#player_stats_table").append('<tr id="player_stats_' + player_id + '"><th scope="row" class=text-center>' + player_name + '</th></tr>');
          
          for(let index = 0; index < stats_length; index++){
            $("#player_stats_" + player_id).append('<td>' + data.player_stats[player_id][index] + '</td>');
          }
        } 
        $("#player_stats_table").append('<tr id="player_stats_DELETED PLAYER"><th scope="row" class=text-center>DELETED PLAYER</th></tr>');
        
        for(let index = 0; index < stats_length; index++){
          $("#player_stats_DELETED PLAYER").append('<td>' + deleted_player_stats[index] + '</td>');
        }
      });
      update_recent_play();
    });
  });
</script>
{% endblock %}